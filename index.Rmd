---
title: Arthropod associations with residual dry matter and foundations shrubs in California
  desert ecosystems
output:
    rmdformats::readthedown:
      collapsed: false
      highlight: kate
---

```{r setup, include=FALSE}
library(tidyverse)
library(purrr)
library(ggthemes)
library(glmmTMB)
library(sjPlot)

env <- read.csv("clean_data/cov.csv")
comm <- read.csv("clean_data/comm.csv")
rdm <- read.csv("clean_data/veg_covariates.csv")
eph <- filter(env, Microsite != "larrea")
```

***

Pitfall traps were deployed along an aridity gradient in California to measure associations of ground-dwelling arthropods with foundation shrubs, and to assess the ability of residual dry matter (RDM) as an indicator of arthropod community structure.

***

## Differences between sites


### Residual dry matter
```{r}
ggplot(rdm, aes(RDM)) + geom_density() + facet_grid(~site) + theme_classic()
ggplot(rdm, aes(Microsite, RDM)) + geom_boxplot() + facet_grid(~site)+ theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```



### Insect morphospecies richness
```{r}
ggplot(env, aes(Species, fill = Microsite)) + geom_density(alpha = 0.7) + facet_grid(~site)+ theme_classic()
ggplot(env, aes(Microsite, Species)) + geom_boxplot() + facet_grid(~site)+ theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```




### Insect abundance
There is one sample with 1200 insects in it, almost all ants that really throws everything off. 
```{r}
env %>% filter(abun < 350) %>% ggplot(aes(abun, fill = Microsite)) + geom_density(alpha = 0.7) + facet_grid(~site)+ theme_classic()

env %>% filter(abun < 350) %>% ggplot(aes(Microsite, abun)) + geom_boxplot() + facet_grid(~site)+ theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Simple counts
```{r}
arth.lg <- read.csv("clean_data/arth_long.csv")
arth.lg <- filter(arth.lg, highest.rtu != "damaged" & highest.rtu != "ignore" & highest.rtu != "alate")
str(arth.lg)

sum(arth.lg$Quantity)
ants <- filter(arth.lg, Family == "Formicidae") 
sum(ants$Quantity)
ants %>% count(highest.rtu)
ants %>% count(morph)
```


## Influence of shrubs on RDM
### Does shrub size influence RDM?
```{r}
ggplot(rdm, aes(x, RDM)) + geom_smooth() + facet_grid(~site) + xlab("Shrub Width")+ theme_classic()

ggplot(rdm, aes(z, RDM)) + geom_smooth() + facet_grid(~site) + xlab("Shrub Height")+ theme_classic()

```

### Is RDM cover greater undershrubs?
```{r}
ggplot(rdm, aes(Microsite, rdm.cov)) + geom_boxplot() + facet_grid(~Region)
```


## Influence of RDM on insect communities

### Morphospecies richness
```{r}
ggplot(eph, aes(RDM, Species)) + geom_smooth(method = lm) + geom_point() + theme_classic()
ggplot(eph, aes(RDM, Species, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic()
ggplot(eph, aes(RDM, Species, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic() + facet_grid(~Region)

```
### Arthropod abundance
```{r}
ggplot(filter(eph, abun < 350), aes(RDM, abun)) + geom_smooth(method = lm) + geom_point() + theme_classic()

ggplot(filter(eph, abun < 350), aes(RDM, abun, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic()

ggplot(filter(eph, abun < 350), aes(RDM, abun, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic() + facet_grid(~Region)
```


## Influence of shrubs on arthropod communities
### Arthropod morphospecies richness

```{r}
ggplot(eph, aes(Microsite, Species)) + geom_boxplot() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(eph, aes(Microsite, Species)) + geom_boxplot() + facet_grid(~Region) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(eph, aes(Microsite, Species)) + geom_boxplot() + facet_grid(~site) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
### Arthropod abundance


```{r}
ggplot(filter(eph, abun <350), aes(Microsite, abun)) + geom_boxplot() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(filter(eph, abun <350), aes(Microsite, abun)) + geom_boxplot() + facet_grid(~Region) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(filter(eph, abun <350), aes(Microsite, abun)) + geom_boxplot() + facet_grid(~site) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Site level RII 
### Residual dry matter

```{r}
rii <- read.csv("clean_data/rii.csv")
ggplot(rii, aes(arid, average, color = response)) + geom_errorbar(aes(arid, ymin = average - error, ymax = average + error)) + geom_point() + geom_jitter() 
ggplot(rii, aes(arid, average, color = response)) + geom_smooth(method = lm)

```


## Individual RII (rdm)

```{r}
indrii <- read.csv("clean_data/rii_individual.csv")
ggplot(indrii, aes(site, rii)) + geom_boxplot()
ggplot(indrii, aes(x, rii)) + geom_point() + geom_smooth(method = lm) + xlab("Shrub Width")
```



# Models

### Drivers of insect morphospecies abundance

```{r}
eph.abun <- filter(eph, abun < 350)
m1 <- glmmTMB(abun ~ Microsite + RDM + (1|Region/site), family = "poisson", data = eph.abun)
summary(m1)
#looks overdispersed

m1.nb <- glmmTMB(abun ~ Microsite + RDM + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m1.nb)

m1.nb1 <- glmmTMB(abun ~ Microsite + RDM + (1|Region/site), family = "nbinom1", data = eph.abun)
summary(m1.nb1)

m1.nb.rdm <- glmmTMB(abun ~ RDM + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m1.nb.rdm)

m2 <- glmmTMB(abun ~ Microsite * RDM + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m2)

AIC(m1, m1.nb, m1.nb1)

#nbinom2 without interaction is the best
summary(m1.nb)
knitr::kable(car::Anova(m1.nb, type = 2))


m3 <- glmmTMB(abun ~ Microsite + rdm.cov + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m3)


AIC(m1.nb, m3)
```

### Insect morphospecies richness

```{r}
m1 <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "poisson", data = eph)
summary(m1)

#nb models don't coverge -> likely suggests overdispersion not an issue but should add a formal check

m1.nb <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "nbinom2", data = eph)

m1.p <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "poisson", data = eph)


anova(m1.nb, m1.p)


m1.nb1 <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "nbinom1", data = eph.abun)

summary(aov(m1.nb, m1.nb1))

m2 <- glmmTMB(Species ~ Microsite * RDM + (1|Region/site), family = "poisson", data = eph)
summary(m2)


plot(fitted(m2), resid(m2))

AIC(m1, m2)

m3.cov <- glmmTMB(Species ~ Microsite + rdm.cov + (1|Region/site), family = "poisson", data = eph)
summary(m3.cov)

summary(m1)
knitr::kable(car::Anova(m1, type = 2))
```

### H


### Residual dry matter

```{r}

rdm <- filter(rdm, Microsite != "larrea")
shapiro.test(rdm$RDM)
#data are right-skewed. There are only a couple of zeroes so dropping them and using Gamma for now.

m1 <- filter(rdm, RDM >0 ) %>% glmmTMB(RDM ~ Microsite + (1|Region/site), family = Gamma, data = .)
summary(m1)




car::Anova(m1, type = 2)
```
### RII differences between sites
```{r}
shapiro.test(indrii$rii)
t.test(indrii$rii)
a1 <- aov(rii ~ Region, data = indrii)
TukeyHSD(a1)

```


```{r}

#want to make a plot of site level rii vs average rii
av <- indrii %>% group_by(site) %>% summarise(mean.rdm = mean(rii))
mets <- filter(rii, response != 'rdm')
av <- right_join(av, mets, by = "site") 

rdm.av <- rdm %>% filter(Microsite == "ephedra") %>% group_by(site) %>% summarise(mean.rdm = mean(RDM))

av <- right_join(av, rdm.av, by = "site")
ggplot(av, aes(mean.rdm.y, average, color = response)) + geom_smooth(method = lm) + geom_point() + xlab("Mean Shrub RII") + ylab("RII")

eph.rdm <- filter(rdm, Microsite != "larrea")
ggplot(eph.rdm, aes(RDM, fill = Microsite)) + geom_density(alpha = 0.7) + theme_classic() + xlab("RDM (g)")

```

## Correlations
```{r}

av %>% filter(response == "richness") %>% cor.test(~mean.rdm.x + average, data =.)
av %>% filter(response == "abun") %>% cor.test(~mean.rdm.x + average, data =.)


```


# Summary of results

* Ephedra signficantly influences insect abundance and richness
* Ephedra supports greater plant biomass

# Future analyses?
* Lavaan structural equation modelling does not support count data
