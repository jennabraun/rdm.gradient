---
title: Arthropod associations with residual dry matter and foundations shrubs in California
  desert ecosystems
output:
    rmdformats::readthedown:
      collapsed: false
      highlight: kate
---

```{r setup, include=FALSE}
library(tidyverse)
library(purrr)
library(ggthemes)
library(glmmTMB)
library(sjPlot)
library(performance)
```

```{r}
env <- read.csv("clean_data/cov.csv")
comm <- read.csv("clean_data/comm.csv")
rdm <- read.csv("clean_data/veg_covariates.csv")
eph <- filter(env, Microsite != "larrea")
str(eph)
eph$Microsite <- as.factor(eph$Microsite)
rdm$Microsite <- as.factor(rdm$Microsite)
eph$Microsite <- relevel(eph$Microsite, ref = "open")
rdm$Microsite <- relevel(rdm$Microsite, ref = "open")

se <- function(x) sd(x, na.rm = TRUE)/sqrt(length(x)) ## SE
```

***

Pitfall traps were deployed along an aridity gradient in California to measure associations of ground-dwelling arthropods with foundation shrubs, and to assess the ability of residual dry matter (RDM) as an indicator of arthropod community structure.

***

## Differences between sites


### Residual dry matter
```{r}
ggplot(rdm, aes(RDM)) + geom_density() + facet_grid(~site) + theme_classic()
ggplot(rdm, aes(Microsite, RDM)) + geom_boxplot() + facet_grid(~site)+ theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```



### Insect morphospecies richness
```{r}
ggplot(env, aes(Species, fill = Microsite)) + geom_density(alpha = 0.7) + facet_grid(~site)+ theme_classic()
ggplot(env, aes(Microsite, Species)) + geom_boxplot() + facet_grid(~site)+ theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```




### Insect abundance
There is one sample with 1200 insects in it, almost all ants that really throws everything off. 
```{r}
env %>% filter(abun < 350) %>% ggplot(aes(abun, fill = Microsite)) + geom_density(alpha = 0.7) + facet_grid(~site)+ theme_classic()

env %>% filter(abun < 350) %>% ggplot(aes(Microsite, abun)) + geom_boxplot() + facet_grid(~site)+ theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))


sum(env$abun)
sum(eph$abun)
```

### Simple counts
```{r}
arth.lg <- read.csv("clean_data/arth_long.csv")
arth.lg <- filter(arth.lg, highest.rtu != "damaged" & highest.rtu != "ignore" & highest.rtu != "alate")
str(arth.lg)

#this is with larrea
sum(arth.lg$Quantity)

ants <- filter(arth.lg, Family == "Formicidae") 
sum(ants$Quantity)
ants %>% count(highest.rtu)
ants %>% count(morph)
```


## Influence of shrubs on RDM
### Does shrub size influence RDM?
```{r}
ggplot(rdm, aes(x, RDM)) + geom_smooth() + facet_grid(~site) + xlab("Shrub Width")+ theme_classic()

ggplot(rdm, aes(z, RDM)) + geom_smooth() + facet_grid(~site) + xlab("Shrub Height")+ theme_classic()

```

### Is RDM cover greater undershrubs?
```{r}
ggplot(rdm, aes(Microsite, rdm.cov)) + geom_boxplot() + facet_grid(~Region)
```


## Influence of RDM on insect communities

### Morphospecies richness
```{r}
ggplot(eph, aes(RDM, Species)) + geom_smooth(method = lm) + geom_point() + theme_classic()
ggplot(eph, aes(RDM, Species, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic()
ggplot(eph, aes(RDM, Species, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic() + facet_grid(~Region)

```
### Arthropod abundance
```{r}
ggplot(filter(eph, abun < 350), aes(RDM, abun)) + geom_smooth(method = lm) + geom_point() + theme_classic()

ggplot(filter(eph, abun < 350), aes(RDM, abun, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic()

ggplot(filter(eph, abun < 350), aes(RDM, abun, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic() + facet_grid(~Region)
```


## Influence of shrubs on arthropod communities
### Arthropod morphospecies richness

```{r}
ggplot(eph, aes(Microsite, Species)) + geom_boxplot() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(eph, aes(Microsite, Species)) + geom_boxplot() + facet_grid(~Region) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(eph, aes(Microsite, Species)) + geom_boxplot() + facet_grid(~site) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
### Arthropod abundance


```{r}
ggplot(filter(eph, abun <350), aes(Microsite, abun)) + geom_boxplot() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(filter(eph, abun <350), aes(Microsite, abun)) + geom_boxplot() + facet_grid(~Region) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(filter(eph, abun <350), aes(Microsite, abun)) + geom_boxplot() + facet_grid(~site) + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Site level RII 
### Residual dry matter

```{r}
rii <- read.csv("clean_data/rii.csv")
ggplot(rii, aes(arid, average, color = response)) + geom_errorbar(aes(arid, ymin = average - error, ymax = average + error)) + geom_point() + geom_jitter() 
ggplot(rii, aes(arid, average, color = response)) + geom_smooth(method = lm)

```


## Individual RII (rdm)

```{r}
indrii <- read.csv("clean_data/rii_individual.csv")
ggplot(indrii, aes(site, rii)) + geom_boxplot()
ggplot(indrii, aes(x, rii)) + geom_point() + geom_smooth(method = lm) + xlab("Shrub Width")
```



# Models

## Drivers of arthropod abundance

```{r}
eph.abun <- filter(eph, abun < 350)
m1 <- glmmTMB(abun ~ Microsite + RDM + (1|Region/site), family = "poisson", data = eph.abun)
summary(m1)
#looks overdispersed

m1.nb <- glmmTMB(abun ~ Microsite + RDM + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m1.nb)

m1.nb1 <- glmmTMB(abun ~ Microsite + RDM + (1|Region/site), family = "nbinom1", data = eph.abun)
summary(m1.nb1)

m1.nb.rdm <- glmmTMB(abun ~ RDM + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m1.nb.rdm)

m2 <- glmmTMB(abun ~ Microsite * RDM + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m2)

AIC(m1, m1.nb, m1.nb1)

#nbinom2 without interaction is the best
summary(m1.nb)
knitr::kable(car::Anova(m1.nb, type = 2))


m3 <- glmmTMB(abun ~ Microsite + rdm.cov + (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m3)
AIC(m1.nb, m3)



m4 <- glmmTMB(abun ~ Microsite + rdm.cov + RDM +  (1|Region/site), family = "nbinom2", data = eph.abun)
summary(m4)
knitr::kable(car::Anova(m4, type = 2))

check_collinearity(m4)
```

## Insect morphospecies richness

```{r}
m1 <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "poisson", data = eph)
summary(m1)

#nb models don't coverge -> likely suggests overdispersion not an issue but should add a formal check

m1.nb <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "nbinom2", data = eph)

m1.p <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "poisson", data = eph)


anova(m1.nb, m1.p)


m1.nb1 <- glmmTMB(Species ~ Microsite + RDM + (1|Region/site), family = "nbinom1", data = eph.abun)

summary(aov(m1.nb, m1.nb1))

m2 <- glmmTMB(Species ~ Microsite * RDM + (1|Region/site), family = "poisson", data = eph)
summary(m2)


plot(fitted(m2), resid(m2))

AIC(m1, m2)

m3.cov <- glmmTMB(Species ~ Microsite + rdm.cov + (1|Region/site), family = "poisson", data = eph)
summary(m3.cov)

m3.cov.in <- glmmTMB(Species ~ Microsite * rdm.cov + (1|Region/site), family = "poisson", data = eph)
summary(m3.cov.in)

m4 <- glmmTMB(Species ~ Microsite + RDM + rdm.cov + (1|Region/site), family = "poisson", data = eph)

summary(m4)
knitr::kable(car::Anova(m4, type = 2))
check_collinearity(m4)
m5 <- glmmTMB(Species ~ Microsite + RDM + rdm.cov + green.cov + non.veg.cov + (1|Region/site), family = "poisson", data = eph)

summary(m5)
```
## Influence of shrub size
```{r, shrub size}

#redo models
#shrub microsite only
shr <- filter(eph, Microsite == "ephedra")

m1.shr <- glmmTMB(Species ~ x + (1|Region/site), family = "poisson", data = shr)
summary(m1.shr)

shr.abun <- filter(eph, abun < 350)
m2.shr <- glmmTMB(abun ~ x + z + (1|Region/site), family = "nbinom2", data = shr.abun)
summary(m2.shr)

```
### Residual dry matter


### RII differences between sites
```{r}
shapiro.test(indrii$rii)
t.test(indrii$rii)
#not normal though

library(boot)
bootmean <- function(d, i) mean(d[i])
RDM.rii <- boot(indrii$rii, bootmean, R=10000, stype ="i")
ci.RDM.rii <- boot.ci(RDM.rii)
bca.RDM <- ci.RDM.rii$bca



rii.cover <- read.csv("clean_data/rii_individual_rdmcover.csv")
str(rii.cover)
mean(rii.cover$rii)


cover.rii <- boot(rii.cover$rii, bootmean, R=1000, stype ="i")
ci.cover.rii <- boot.ci(cover.rii)
bca.cover <- ci.cover.rii$bca
t.test(rii.cover$rii)
```


```{r}

#want to make a plot of site level rii vs average rii
av <- indrii %>% group_by(site) %>% summarise(mean.rdm = mean(rii))
mets <- filter(rii, response != 'rdm')
av <- right_join(av, mets, by = "site") 

rdm.av <- rdm %>% filter(Microsite == "ephedra") %>% group_by(site) %>% summarise(mean.rdm = mean(RDM))

av <- right_join(av, rdm.av, by = "site")
ggplot(av, aes(mean.rdm.y, average, color = response)) + geom_smooth(method = lm) + geom_point() + xlab("Mean RDM under shrub (g)") + ylab("RII")

eph.rdm <- filter(rdm, Microsite != "larrea")
ggplot(eph.rdm, aes(RDM, fill = Microsite)) + geom_density(alpha = 0.7) + theme_classic() + xlab("RDM (g)")

```

## Correlations
```{r}

av %>% filter(response == "richness") %>% cor.test(~mean.rdm.x + average, data =.)
av %>% filter(response == "abun") %>% cor.test(~mean.rdm.x + average, data =.)

av %>% filter(response == "richness") %>% cor.test(~mean.rdm.y + average, data =.)
av %>% filter(response == "abun") %>% cor.test(~mean.rdm.y + average, data =.)

```

## Ephedra summary stats 
```{r}
arth.eph <- filter(arth.lg, Microsite != "larrea")

sum(arth.eph$Quantity)

ants <- filter(arth.eph, Family == "Formicidae") 
sum(ants$Quantity)
ants %>% count(highest.rtu)
ants %>% count(morph)


mean(eph.abun$abun)
sd(eph.abun$abun)



#let's make a few summary figures
#these only have the trap spots

#by region
region.mean <- data.frame()

region.mean <- eph.abun %>% group_by(Region, Microsite) %>% summarise(mean.abun = mean(abun),  mean.rich = mean(Species))  %>% gather(var, mean, 3:4)

region.mean.plant <- data.frame()
region.mean.plant <- eph.rdm %>% group_by(Region, Microsite) %>% summarise(mean.RDM = mean(RDM, na.rm = TRUE),  mean.cover = mean(rdm.cov, na.rm = TRUE)) %>% gather(var, mean, 3:4)

region.se <- eph.abun %>% group_by(Region, Microsite) %>% summarise(se.abun = se(abun), se.rich = se(Species)) %>% gather(var, se, 3:4)

region.se.plant <- eph.rdm %>% group_by(Region, Microsite) %>% summarise(se.RDM = se(RDM), se.cover = se(rdm.cov)) %>% gather(var, se, 3:4)


region.summ <-data.frame()
region.mean <- rbind(region.mean, region.mean.plant)
region.se <- rbind(region.se, region.se.plant)

region.summ <- cbind(region.mean, region.se)
region.summ <- region.summ[, -c(5:7)]


region.summ$Region <- factor(region.summ$Region, levels = c("Panoche", "Cuyama", "Mojave"))
region.summ$var <- factor(region.summ$var, levels = c("mean.RDM", "mean.cover", "mean.abun", "mean.rich"))
region.summ$Microsite <- factor(region.summ$Microsite, levels = c("ephedra", "open"))

labels <- c(mean.RDM = "RDM biomass (g)", mean.cover = "RDM cover", mean.abun = "Arthropod abundance", mean.rich = "Arthropod richness")

ggplot(region.summ, aes(Region, mean, colour = Microsite)) + geom_point(position=position_dodge(width=0.9), aes(y=mean, colour=Microsite)) + geom_errorbar(aes(Region,  ymax = mean + se, ymin = mean - se), position = "dodge") + facet_wrap(.~var, scales = "free", labeller = labeller(var = labels)) + theme_bw(base_size = 16) + scale_colour_manual(values = c("black", "red")) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + ylab("Mean")

```


```{r}
ggplot(eph, aes(RDM, Species)) + geom_smooth(method = lm) + geom_point() + theme_classic()
ggplot(eph, aes(RDM, Species, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic()
ggplot(eph, aes(RDM, Species, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic() + facet_grid(~Region)

```
### Arthropod abundance
```{r}
ggplot(filter(eph, abun < 350), aes(RDM, abun)) + geom_smooth(method = lm) + geom_point() + theme_classic()

ggplot(filter(eph, abun < 350), aes(RDM, abun, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic()

ggplot(filter(eph, abun < 350), aes(RDM, abun, fill = Microsite)) + geom_smooth(method = lm) + geom_point() + theme_classic() + facet_grid(~Region)


```



# Summary of results

* Ephedra signficantly influences insect abundance and richness
* Ephedra supports greater plant biomass

# Future analyses?
* Lavaan structural equation modelling does not support count data
